/* DOJ page JS extracted from doj.html */
let peines = [];

async function loadCSV(){
    try{
        const res = await fetch('code_penal.csv');
        const text = await res.text();
        parseCSV(text);
        populateDatalist();
        try{ updateTotals(); }catch(e){}
    }catch(e){ console.error('Erreur loadCSV', e); }
}

function parseCSV(text){
    peines = [];
    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length);
    for(const line of lines){ if (/^â˜…|^Article|^\/|^;/.test(line)) continue; const parts = line.split(';').map(p=>p.trim()).filter(p=>p.length); if(parts.length===0) continue; const name = parts[0], fine = parts[1]||'', time = parts[2]||''; peines.push({name,fine,time,raw:line}); }
    const seen = new Set(); peines = peines.filter(p=>{ if(seen.has(p.name)) return false; seen.add(p.name); return true }); peines.sort((a,b)=> a.name.localeCompare(b.name,'fr'));
}

function populateDatalist(){ const dl = document.getElementById('faits_doj'); if(!dl) return; dl.innerHTML=''; peines.forEach(p=>{ const opt=document.createElement('option'); opt.value=p.name; dl.appendChild(opt); }); }

function parseTimeToMinutes(s){ if(!s) return 0; s = s.toString(); const m = s.match(/(\d+)\s*mins?/i); if(m) return parseInt(m[1],10); const h = s.match(/(\d+)\s*h/i); if(h) return parseInt(h[1],10)*60; const h2 = s.match(/(\d+)\s*heures?/i); if(h2) return parseInt(h2[1],10)*60; return 0; }
function formatMinutes(total){ total = Number(total) || 0; const hrs = Math.floor(total/60); const mins = total % 60; return `${hrs}h${String(mins).padStart(2,'0')}`; }

function updateTotals(){ const container = document.getElementById('faits_list'); let totalMinutes = 0; let totalFine = 0; if(container){ const children = Array.from(container.children).filter(n=> n && n.firstChild && n.firstChild.dataset && n.firstChild.dataset.fait); children.forEach(c => { const fname = c.firstChild.dataset.fait; const p = peines.find(x => x.name.toLowerCase() === fname.toLowerCase()); if(p){ if(p.time) totalMinutes += parseTimeToMinutes(p.time); if(p.fine){ const num = parseInt(p.fine.replace(/[^0-9\-]/g,''),10); if(!isNaN(num)) totalFine += num; } } }); } const tempsEl = document.getElementById('temps'); const amendeEl = document.getElementById('amende'); if(tempsEl) tempsEl.value = formatMinutes(totalMinutes); if(amendeEl) amendeEl.value = (totalFine ? (totalFine + '$') : '$0'); }

function addFaitDoj(){ const v = (document.getElementById('fait_input')?.value||'').trim(); const errEl = document.getElementById('faits_error'); if(errEl){ errEl.style.display='none'; errEl.innerText=''; } if(!v){ if(errEl){ errEl.innerText = 'Veuillez choisir ou saisir un fait.'; errEl.style.display='block'; } return; } const container = document.getElementById('faits_list'); if(!container) return; const current = Array.from(container.children).filter(n=> n && n.firstChild && n.firstChild.dataset && n.firstChild.dataset.fait).length; if(current >= 6){ if(errEl){ errEl.innerText = 'Nombre maximum de faits (6) atteint.'; errEl.style.display='block'; } return; } const existing = Array.from(container.children).some(n=> n && n.firstChild && n.firstChild.dataset && n.firstChild.dataset.fait && n.firstChild.dataset.fait.toLowerCase()===v.toLowerCase()); if(existing){ if(errEl){ errEl.innerText = 'Ce fait a dÃ©jÃ  Ã©tÃ© ajoutÃ©.'; errEl.style.display='block'; } document.getElementById('fait_input').value=''; return; } if(container.innerText.includes('Aucun fait')) container.innerHTML=''; const found = peines.find(p=> p.name.toLowerCase() === v.toLowerCase()); const candidateMinutes = found && found.time ? parseTimeToMinutes(found.time) : 0; let currentTotal = 0; const existingChildren = Array.from(container.children).filter(n=> n && n.firstChild && n.firstChild.dataset && n.firstChild.dataset.fait); existingChildren.forEach(c=>{ const fname = c.firstChild.dataset.fait; const p = peines.find(x=> x.name.toLowerCase()===fname.toLowerCase()); if(p && p.time) currentTotal += parseTimeToMinutes(p.time); }); const MAX_MINUTES = 90; if((currentTotal + candidateMinutes) > MAX_MINUTES){ if(errEl){ errEl.innerText = 'DurÃ©e cumulÃ©e maximale (1h30) dÃ©passÃ©e â€” impossible d\'ajouter ce fait.'; errEl.style.display='block'; } document.getElementById('fait_input').value=''; return; } const d = document.createElement('div'); d.className='border rounded p-2 mb-2 d-flex justify-content-between align-items-center'; const span = document.createElement('span'); span.innerText = v; span.dataset.fait = v; const btn = document.createElement('button'); btn.type='button'; btn.className='btn btn-sm btn-link'; btn.style.color='#c0392b'; btn.innerText='âœ–'; btn.addEventListener('click', function(){ d.remove(); if(!container.children.length) container.innerText='Aucun fait'; updateTotals(); const e = document.getElementById('faits_error'); if(e){ const nowCount = Array.from(container.children).filter(n=> n && n.firstChild && n.firstChild.dataset && n.firstChild.dataset.fait).length; if(nowCount < 6){ e.style.display='none'; e.innerText=''; } let tot=0; const kids = Array.from(container.children).filter(n=> n && n.firstChild && n.firstChild.dataset && n.firstChild.dataset.fait); kids.forEach(function(c){ const fn = c.firstChild.dataset.fait; const p = peines.find(x=> x.name.toLowerCase()===fn.toLowerCase()); if(p && p.time) tot += parseTimeToMinutes(p.time); }); if(tot <= MAX_MINUTES){ e.style.display='none'; e.innerText=''; } } }); d.appendChild(span); d.appendChild(btn); container.appendChild(d); document.getElementById('fait_input').value=''; updateTotals(); }

function buildComparutionText(){ const dest = (document.getElementById('destinataires')?.value || '').trim(); let dateVal = document.getElementById('date_delib')?.value || ''; if(dateVal){ const d = new Date(dateVal); const pad = n=>n.toString().padStart(2,'0'); dateVal = `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`; } const decision = (document.getElementById('decision')?.value || '').trim(); const temps = (document.getElementById('temps')?.value || '').trim(); const amende = (document.getElementById('amende')?.value || '').trim(); const ident = (document.getElementById('identite')?.value || '').trim(); const med_link = (document.getElementById('med_link')?.value || '').trim(); const container = document.getElementById('faits_list'); let faits=[]; if(container){ const children = Array.from(container.children).filter(n=> n && n.firstChild && n.firstChild.dataset && n.firstChild.dataset.fait); if(children.length) faits = children.map(c=> c.firstChild.dataset.fait); } const delim = 'â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬'; let txt = ''; txt+=delim + '\n'; txt+='# Comparution\n'; txt+=`:man_judge: Juge / Procureur / OPJ : ${dest}\n`; txt+=`:calendar_spiral: Date de dÃ©libÃ©ration : ${dateVal}\n`; txt+=`:scales: DÃ©cision : ${decision}\n`; txt+=`:clock3: Temps : ${temps}\n`; txt+=`:moneybag: Amende : ${amende}\n`; txt+=`:no_entry: Faits retenus : ${faits.length? '\n'+faits.map(f=>' - '+f).join('\n') : ''}\n`; txt+=`:bust_in_silhouette: IdentitÃ© suspect : ${ident}\n`; txt+=`:pencil: Lien de la MED : ${med_link}\n`; txt+=delim+'\n'; return txt; }

function previewComparution(){ const txt = buildComparutionText(); const escapeHtml = s=> (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); const dest = escapeHtml((document.getElementById('destinataires')?.value||'').trim()); const dateVal = escapeHtml((document.getElementById('date_delib')?.value||'').trim()); const decision = escapeHtml((document.getElementById('decision')?.value||'').trim()); const temps = escapeHtml((document.getElementById('temps')?.value||'').trim()); const amende = escapeHtml((document.getElementById('amende')?.value||'').trim()); const ident = escapeHtml((document.getElementById('identite')?.value||'').trim()); const med_link = escapeHtml((document.getElementById('med_link')?.value||'').trim()); const container = document.getElementById('faits_list'); let faits=[]; if(container){ const children = Array.from(container.children).filter(n=>n && n.firstChild && n.firstChild.dataset && n.firstChild.dataset.fait); if(children.length) faits = children.map(c=> escapeHtml(c.firstChild.dataset.fait)); } const parts=[]; parts.push('<div style="font-weight:700;margin-bottom:.5rem">Comparution</div>'); parts.push('<div><strong>ğŸ‘©â€âš–ï¸ Juge / Procureur / OPJ :</strong> ' + dest + '</div>'); parts.push('<div><strong>ğŸ—“ï¸ Date de dÃ©libÃ©ration :</strong> ' + dateVal + '</div>'); parts.push('<div><strong>âš–ï¸ DÃ©cision :</strong> ' + decision + '</div>'); parts.push('<div><strong>â±ï¸ Temps :</strong> ' + temps + '</div>'); parts.push('<div><strong>ğŸ’° Amende :</strong> ' + amende + '</div>'); if(faits.length) parts.push('<div><strong>ğŸš« Faits retenus :</strong></div><ul>' + faits.map(f=>'<li>'+f+'</li>').join('') + '</ul>'); else parts.push('<div><strong>ğŸš« Faits retenus :</strong> (aucun)</div>'); parts.push('<div><strong>ğŸ‘¤ IdentitÃ© suspect :</strong> ' + ident + '</div>'); parts.push('<div><strong>âœï¸ Lien de la MED :</strong> ' + (med_link? ('<a href="'+med_link+'" target="_blank" rel="noreferrer">'+med_link+'</a>') : '') + '</div>'); const el = document.getElementById('preview_comp_html'); if(el) el.innerHTML = parts.join('\n'); }

function copyComparution(){ const txt = buildComparutionText(); function fallbackCopy(text){ const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); document.body.removeChild(ta); return true; }catch(e){ document.body.removeChild(ta); return false; } } if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(txt).then(()=>alert('Comparution copiÃ©e dans le presse-papiers.')).catch(()=>{ if(fallbackCopy(txt)) alert('Comparution copiÃ©e (fallback).'); else alert('Ã‰chec de copie.'); }); } else { if(fallbackCopy(txt)) alert('Comparution copiÃ©e (fallback).'); else alert('Ã‰chec de copie.'); } }


// init
document.addEventListener('DOMContentLoaded', ()=>{
    loadCSV();
    // Theme handled by js/theme.js (shared module)
    try{ const fi = document.getElementById('fait_input'); if(fi) fi.addEventListener('input', ()=>{ const e = document.getElementById('faits_error'); if(e){ e.style.display='none'; e.innerText=''; } }); }catch(e){}
});

// expose globals
window.addFaitDoj = addFaitDoj;
window.updateTotals = updateTotals;
window.previewComparution = previewComparution;
window.copyComparution = copyComparution;
