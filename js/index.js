/* Per-page JS extracted from index.html
   Exposes functions used by inline attributes: add_fait, reset_faits, med, previewMed, copyPreview, avocat, appelDoj, etc.
*/

let peines = [];
let lastBuiltMed = null;

async function loadCSV(){
    try{
        const res = await fetch('code_penal.csv');
        const text = await res.text();
        parseCSV(text);
        populateControls();
        try{ if (typeof updateDojButtonVisibility === 'function') updateDojButtonVisibility(); }catch(e){}
    }catch(e){ console.error('Impossible de charger code_penal.csv:', e); const el=document.getElementById('peine_details'); if(el) el.innerText='Erreur de chargement du fichier CSV.'; }
}

function parseCSV(text){
    peines = [];
    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length);
    for(const line of lines){
        if (/^â˜…|^Article|^\/|^;/.test(line)) continue;
        const parts = line.split(';').map(p=>p.trim()).filter(p=>p.length);
        if(parts.length===0) continue;
        const name = parts[0], fine = parts[1]||'', time = parts[2]||'';
        peines.push({name,fine,time,raw:line});
    }
    const seen = new Set();
    peines = peines.filter(p=>{ if(seen.has(p.name)) return false; seen.add(p.name); return true });
    peines.sort((a,b)=> a.name.localeCompare(b.name,'fr'));
}

function populateControls(){ const datalist = document.getElementById('faits_tb'); if(datalist) datalist.innerHTML=''; peines.forEach(p=>{ if(datalist){ const opt=document.createElement('option'); opt.value=p.name; datalist.appendChild(opt); } }); }

function showPeineDetails(value){ if(!value){ const el=document.getElementById('peine_details'); if(el) el.innerText='Aucune peine sÃ©lectionnÃ©e'; return; } const found = peines.find(p=> p.name.toLowerCase()===value.toLowerCase()); const el=document.getElementById('peine_details'); if(found){ const fine = found.fine? `Amende: ${found.fine}`:'Amende: N/A'; const time = found.time? `Temps: ${found.time}`:'Temps: N/A'; if(el) el.innerText = `${found.name} â€” ${fine} â€” ${time}`; } else if(el){ el.innerText = 'Aucune correspondance exacte trouvÃ©e dans le CSV.'; } }

function parseTimeToMinutes(s){ if(!s) return 0; s = s.toString(); const m = s.match(/(\d+)\s*mins?/i); if(m) return parseInt(m[1],10); const h = s.match(/(\d+)\s*heures?/i); if(h) return parseInt(h[1],10)*60; const h2 = s.match(/(\d+)\s*h\b/i); if(h2) return parseInt(h2[1],10)*60; return 0; }
function formatMinutes(total){ const t = Math.max(0, Math.min(60, Number(total) || 0)); const hrs = Math.floor(t / 60); const mins = t % 60; const hh = hrs.toString(); const mm = mins.toString().padStart(2, '0'); return `${hh}h${mm}`; }

function add_fait(){ const val = (document.getElementById('faits')?.value||'').trim(); const errEl = document.getElementById('faits_error'); if(errEl){ errEl.style.display='none'; errEl.innerText=''; } if(!val){ if(errEl){ errEl.innerText='Veuillez choisir ou saisir une peine.'; errEl.style.display='block'; } return; } const found = peines.find(p=> p.name.toLowerCase()===val.toLowerCase()); const container = document.getElementById('add_2'); if(!container) return; const existing = Array.from(container.children).filter(n=> n && (n.dataset?.faitName || n.innerText)).length; if(existing>=3){ if(errEl){ errEl.innerText='Maximum 3 faits autorisÃ©s.'; errEl.style.display='block'; } return; } const duplicate = Array.from(container.children).some(n=> n && (n.dataset && n.dataset.faitName) && (n.dataset.faitName.trim().toLowerCase() === val.toLowerCase())); if(duplicate){ if(errEl){ errEl.innerText='Ce fait a dÃ©jÃ  Ã©tÃ© ajoutÃ©.'; errEl.style.display='block'; } document.getElementById('faits').value=''; return; } if(container.innerText.includes('Pas de faits')) container.innerHTML=''; const div = document.createElement('div'); div.className='border rounded p-2 mb-2 fact-item'; const nameToShow = found ? found.name : val; div.dataset.faitName = nameToShow; const span = document.createElement('span'); span.className='fact-name'; span.innerText = nameToShow; const btn = document.createElement('button'); btn.type='button'; btn.className='fact-remove'; btn.title='Supprimer ce fait'; btn.innerText='âœ–'; btn.addEventListener('click', ()=>{ div.remove(); const remaining = Array.from(container.children).filter(n=> n && (n.dataset?.faitName || n.innerText)); if(!remaining.length) container.innerText = 'Pas de faits pour l\'instant'; const e = document.getElementById('faits_error'); if(e){ const nowCount = remaining.length; if(nowCount<3){ e.style.display='none'; e.innerText=''; } } try{ updateDojButtonVisibility(); }catch(e){} }); div.appendChild(span); div.appendChild(btn); container.appendChild(div); document.getElementById('faits').value=''; const pd = document.getElementById('peine_details'); if(pd) pd.innerText='Aucune peine sÃ©lectionnÃ©e'; try{ updateDojButtonVisibility(); }catch(e){} }

function reset_faits(){ const container = document.getElementById('add_2'); if(container) container.innerText='Pas de faits pour l\'instant'; try{ updateDojButtonVisibility(); }catch(e){} }

function buildMedText(){ const nom = (document.getElementById('nom')?.value||'').trim(); const mail = (document.getElementById('mail')?.value||'').trim(); const objets = (document.getElementById('objetsSaisis')?.value||'').trim()||'Biens personnels'; const agents = (document.getElementById('agents')?.value||'').trim(); const now = new Date(); const pad=n=>n.toString().padStart(2,'0'); const dateStr = `${pad(now.getDate())}/${pad(now.getMonth()+1)}/${now.getFullYear()} Ã  ${pad(now.getHours())}:${pad(now.getMinutes())}`; const faitsContainer = document.getElementById('add_2'); let faitsList = []; if(faitsContainer){ if(faitsContainer.innerText && /Pas de faits/i.test(faitsContainer.innerText)){ const peineVal = (document.getElementById('faits')?.value||'').trim(); if(peineVal) faitsList.push(peineVal); } else { const children = Array.from(faitsContainer.children).filter(n=> n && (n.dataset?.faitName || n.innerText)); if(children.length) faitsList = children.map(c => (c.dataset && c.dataset.faitName) ? c.dataset.faitName.trim() : c.innerText.split('\n')[0].trim()); else { const peineVal = (document.getElementById('faits')?.value||'').trim(); if(peineVal) faitsList.push(peineVal); } } } let totalMinutes = 0; let totalFine = 0; let fineFound=false; faitsList.forEach(f=>{ const p = peines.find(x=> x.name.toLowerCase()===f.toLowerCase()); if(p && p.time) totalMinutes += parseTimeToMinutes(p.time); if(p && p.fine){ const num = parseInt(p.fine.replace(/[^0-9\-]/g,''),10); if(!isNaN(num)){ totalFine+=num; fineFound=true; } } }); const tempsDetention = formatMinutes(totalMinutes); const amende = fineFound ? (totalFine+'$') : ''; const uniq = 'ID-'+Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,8).toUpperCase(); const delim = 'â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬'; let txt = ''; txt+=delim+'\n'; txt+=`:calendar_spiral: Date: ${dateStr}\n`; txt+=`:bust_in_silhouette: Nom du suspect : ${nom}\n`; txt+=`:incoming_envelope: Email du suspect : ${mail}\n`; txt+=`:hourglass_flowing_sand: Temps de la dÃ©tention : ${tempsDetention}\n`; if(faitsList.length){ txt+=`:book: Faits :\n`; faitsList.forEach(f=> txt+= '- ' + (f||'').replace(/\r?\n/g,' ').trim() + '\n'); } else { const peineVal = (document.getElementById('faits')?.value||'').trim(); txt+=`:book: Faits : ${peineVal}\n`; } txt+=`:dollar: Amende :  ${amende}\n`; txt+=`:briefcase: Biens personnels saisis : ${objets}\n`; txt+=`:school_satchel: Biens personnels Ã  rendre : Biens personnels\n`; const avocatChecked = document.getElementById('avocat_checkbox')?.checked; txt+=`:man_student: Avocat : ${avocatChecked ? 'Oui' : 'Non'}\n`; txt+=`:scales: Comparution : Non\n`; txt+=`:envelope: ID unique de l\'individu : ${uniq}\n`; txt+=`:man_police_officer: ClÃ´turÃ© par : ${agents}\n`; txt+=delim+'\n'; const meta = { suspectName: nom||'', med_link: (document.getElementById('med_link')?.value||'').trim(), faitsList, amende, tempsDetention: tempsDetention, matricule: (document.getElementById('matricule')?.value||'').trim(), poste: (document.getElementById('poste')?.value||'').trim(), agents }; return { text: txt, meta } }

function copyText(text){ function fallbackCopySync(t){ const ta=document.createElement('textarea'); ta.value=t; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); document.body.removeChild(ta); return true;}catch(e){ document.body.removeChild(ta); return false; } } if(navigator.clipboard && navigator.clipboard.writeText){ return navigator.clipboard.writeText(text).then(()=>true).catch(()=> Promise.resolve(fallbackCopySync(text))); } return Promise.resolve(fallbackCopySync(text)); }

function med(){ const res = buildMedText(); const medText = res.text||''; const meta = res.meta||{}; const now = new Date(); const pad=n=>n.toString().padStart(2,'0'); const heure = `${pad(now.getHours())}:${pad(now.getMinutes())}`; const dateStr = `${pad(now.getDate())}/${pad(now.getMonth()+1)}/${now.getFullYear()}`; const suspect = meta.suspectName || ''; const accusations = (Array.isArray(meta.faitsList) && meta.faitsList.length) ? meta.faitsList.join(', ') : ((document.getElementById('faits')?.value||'').trim()); let noticeText=''; noticeText += `Monsieur | Madame : ${suspect}, il est actuellement ${heure} et nous sommes le ${dateStr}.\n\n`; noticeText += `Vous Ãªtes placÃ© en garde Ã  vue pour les faits suivants : ${accusations}. Vous avez le droit de garder le silence. Si vous renoncez Ã  ce droit, tout ce que vous direz pourra et sera retenu contre vous devant une cour de justice.\n\n`; noticeText += `Vous avez le droit d'avoir un avocat, et, que celui-ci soit prÃ©sent lors de votre interrogatoire. Si vous n'en avez pas les moyens, un avocat vous sera commis d'office si disponible.\n\n`; noticeText += `Vous avez Ã©galement le droit Ã  une assistance mÃ©dicale et d'avoir Ã  manger et Ã  boire.\n\n`; noticeText += `Avez-vous bien compris vos droits ?\nSouhaitez-vous un avocat et / ou avoir une assistance mÃ©dicale ?\n\n`; noticeText += `A bien dire 3 fois si la personne ne comprend pas, au dessus vous pouvez passez Ã  la suite`; try{ localStorage.setItem('sapd_last_med', JSON.stringify(meta)); }catch(e){} const content = document.getElementById('previewHtml'); if(content){ const safe = s=> (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); const parts=[]; parts.push('<div style="font-weight:700;margin-bottom:.5rem">Lecture des droits â€” Mise en dÃ©tention</div>'); parts.push('<div style="line-height:1.4">'); parts.push('<div><strong>Monsieur | Madame :</strong> ' + safe(suspect) + ', <strong>il est actuellement</strong> ' + safe(heure) + ' <strong>et nous sommes le</strong> ' + safe(dateStr) + '.</div>'); parts.push('<p>Vous Ãªtes placÃ© en garde Ã  vue pour les faits suivants : <em>' + safe(accusations) + '</em>.</p>'); parts.push('<p>Vous avez le droit de garder le silence. Si vous renoncez Ã  ce droit, tout ce que vous direz pourra et sera retenu contre vous devant une cour de justice.</p>'); parts.push('<p>Vous avez le droit d\'avoir un avocat, et que celui-ci soit prÃ©sent lors de votre interrogatoire. Si vous n\'en avez pas les moyens, un avocat vous sera commis d\'office si disponible.</p>'); parts.push('<p>Vous avez Ã©galement le droit Ã  une assistance mÃ©dicale et d\'avoir Ã  manger et Ã  boire.</p>'); parts.push('<p><strong>Avez-vous bien compris vos droits ?</strong><br>Souhaitez-vous un avocat et / ou avoir une assistance mÃ©dicale ?</p>'); parts.push('<p style="color:#777;font-size:.9rem">A bien dire 3 fois si la personne ne comprend pas, au dessus vous pouvez passer Ã  la suite.</p>'); parts.push('</div>'); content.innerHTML = parts.join('\n'); } window.lastBuiltMed = { text: medText, meta }; const overlay = document.getElementById('previewOverlay'); if(overlay) overlay.style.display='flex'; copyText(medText).then(()=> showCopyBadge('M.E.D copiÃ©e')).catch(()=> showCopyBadge('Copie impossible')); }

function previewMed(){ const res = buildMedText(); window.lastBuiltMed = res; const content = document.getElementById('previewHtml'); if(content) content.innerHTML = formatMedHtml(res); const overlay = document.getElementById('previewOverlay'); if(overlay) overlay.style.display='flex'; }
function closePreview(){ const overlay = document.getElementById('previewOverlay'); if(overlay) overlay.style.display = 'none'; }
function copyPreview(){ if(!window.lastBuiltMed) return; copyText(window.lastBuiltMed.text).then(ok=> showCopyBadge(ok? 'M.E.D copiÃ©e':'Ã‰chec de la copie')); }
function formatMedHtml(res){ const m = res.meta||{}; const lines=[]; const escapeHtml = s=> (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); lines.push('<div style="font-weight:700;margin-bottom:.5rem">M.E.D â€” PrÃ©visualisation</div>'); lines.push('<div style="font-size:.95rem;line-height:1.3">'); lines.push('<div><strong>ğŸ“… Date :</strong> ' + escapeHtml(new Date().toLocaleString()) + '</div>'); lines.push('<div><strong>ğŸ‘¤ Nom :</strong> ' + escapeHtml(m.suspectName||'') + '</div>'); lines.push('<div><strong>âœ‰ï¸ Email :</strong> ' + escapeHtml(document.getElementById('mail')?.value||'') + '</div>'); lines.push('<div><strong>â±ï¸ Temps de dÃ©tention :</strong> ' + escapeHtml(m.tempsDetention||'') + '</div>'); if(Array.isArray(m.faitsList) && m.faitsList.length){ lines.push('<div><strong>ğŸ“š Faits :</strong></div>'); lines.push('<ul>'); m.faitsList.forEach(f=> lines.push('<li>'+escapeHtml(f)+'</li>')); lines.push('</ul>'); } lines.push('<div><strong>ğŸ’° Amende :</strong> ' + escapeHtml(m.amende||'') + '</div>'); lines.push('<div><strong>ğŸ’¼ Objets saisis :</strong> ' + escapeHtml(document.getElementById('objetsSaisis')?.value||'') + '</div>'); lines.push('<div><strong>ğŸ‘¨â€âš–ï¸ Avocat :</strong> ' + (document.getElementById('avocat_checkbox')?.checked ? 'Oui' : 'Non') + '</div>'); lines.push('<div><strong>ğŸ“ Lien M.E.D :</strong> ' + (m.med_link ? ('<a href="'+escapeHtml(m.med_link)+'" target="_blank" rel="noreferrer">'+escapeHtml(m.med_link)+'</a>') : '') + '</div>'); lines.push('<div style="margin-top:.5rem;color:#666;font-size:.85rem">ID: ' + escapeHtml(m.matricule||'') + ' Â· Poste: ' + escapeHtml(m.poste||'') + '</div>'); lines.push('</div>'); return lines.join('\n'); }

function showCopyBadge(msg){ try{ const b = document.getElementById('copyBadge'); if(!b) return; b.innerText = msg||'CopiÃ©'; b.style.display='block'; b.style.opacity='1'; b.style.transition=''; setTimeout(()=>{ b.style.transition='opacity .35s ease'; b.style.opacity='0'; setTimeout(()=>{ b.style.display='none'; }, 350); }, 1400); }catch(e){} }

function avocat(){ const matricule = (document.getElementById('agents')?.value||'').trim(); const nom = (document.getElementById('nom')?.value||'').trim(); const poste = (document.getElementById('poste')?.value||'Vespucci').trim(); const now = new Date(); const pad=n=>n.toString().padStart(2,'0'); const dateStr = `${pad(now.getDate())}/${pad(now.getMonth()+1)}/${now.getFullYear()} Ã  ${pad(now.getHours())}:${pad(now.getMinutes())}`; const delim='â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬'; let txt=''; txt+=delim+'\n'; txt+= 'ğŸ‘®ğŸ» Matricule: ' + matricule + '\n'; txt+= 'ğŸ—“ï¸ Date: ' + dateStr + '\n'; txt+= 'ğŸ™â€â™‚ï¸ Nom et prÃ©nom du suspect: ' + nom + '\n'; txt+= 'ğŸ“ Demande: @Avocat' + '\n'; txt+= 'ğŸ“ Poste de Police: ' + poste + '\n'; txt+=delim+'\n'; copyText(txt).then(()=> alert('Message avocat copiÃ© dans le presse-papiers.')).catch(()=> alert('Ã‰chec de copie.')); }

function appelDoj(){ const poste = (document.getElementById('poste')?.value||'Vespucci').trim(); const medLink = (document.getElementById('med_link')?.value||'').trim(); let txt=''; const header='===================================================='; txt+=header+'\n'; txt+='Courrier Ã  destination de : @ğŸ‘©ğŸ»â€âš–ï¸ | Juge  @âš–ï¸ | Procureur @ğŸ“Officier Police Judiciaire\n'; txt+=header+'\n\n'; txt+='Bonjour,\n\n'; txt+='Votre prÃ©sence est mandatÃ©e. Merci de vous prÃ©senter aux cellules du poste de '+poste+'.\n\n'; txt+='Bien Ã  vous,\n\n'; txt+='ğŸ“šLien de la M.E.D:\n'+medLink+'\n'; copyText(txt).then(()=> alert('Courrier DOj copiÃ© dans le presse-papiers.')).catch(()=> alert('Ã‰chec de copie.')); }

function updateDojButtonVisibility(){ try{ const btn = document.getElementById('btn_doj_call'); if(!btn) return; const faitsContainer = document.getElementById('add_2'); let faitsList=[]; if(faitsContainer){ if(faitsContainer.innerText && /Pas de faits/i.test(faitsContainer.innerText)){ const peineVal = (document.getElementById('faits')?.value||'').trim(); if(peineVal) faitsList.push(peineVal); } else { const children = Array.from(faitsContainer.children).filter(n=> n && (n.dataset?.faitName || n.innerText)); if(children.length) faitsList = children.map(c=> (c.dataset && c.dataset.faitName) ? c.dataset.faitName.trim() : c.innerText.split('\n')[0].trim()); else { const peineVal = (document.getElementById('faits')?.value||'').trim(); if(peineVal) faitsList.push(peineVal); } } } let hasCrime=false; for(const f of faitsList){ const p = peines.find(x=> x.name.toLowerCase()===f.toLowerCase()); if(p && /crime/i.test(p.raw||p.name||'')){ hasCrime=true; break; } if(p && /peine fÃ©dÃ©rale/i.test(p.raw||p.name||'')){ hasCrime=true; break; } } btn.style.display = hasCrime ? '' : 'none'; }catch(e){ console.error('updateDojButtonVisibility error', e); } }

function toggleAvocatControls(){ const checked = document.getElementById('avocat_checkbox')?.checked; const btn = document.getElementById('btn_avocat_call'); const medGroup = document.getElementById('med_link_group'); const posteGroup = document.getElementById('poste_group'); if(btn) btn.style.display = checked ? '' : 'none'; if(medGroup) medGroup.style.display = checked ? '' : 'none'; if(posteGroup) posteGroup.style.display = checked ? '' : 'none'; }

function previewMed(){ const res = buildMedText(); lastBuiltMed = res; const content = document.getElementById('previewHtml'); if(content) content.innerHTML = formatMedHtml(res); const overlay = document.getElementById('previewOverlay'); if(overlay) overlay.style.display = 'flex'; }

function closePreview(){ const overlay = document.getElementById('previewOverlay'); if(overlay) overlay.style.display = 'none'; }

// Theme handling (index page)

// small helpers for UI bindings
document.addEventListener('DOMContentLoaded', ()=>{
    try{ loadCSV(); }catch(e){}
    try{ const fi = document.getElementById('faits'); if(fi) fi.addEventListener('input', ()=>{ const e = document.getElementById('faits_error'); if(e){ e.style.display='none'; e.innerText=''; } }); }catch(e){}
    try{ const fi2 = document.getElementById('fait_input'); if(fi2) fi2.addEventListener('input', ()=>{ const e = document.getElementById('faits_error'); if(e){ e.style.display='none'; e.innerText=''; } }); }catch(e){}
    try{ const avocatCheckbox = document.getElementById('avocat_checkbox'); if(avocatCheckbox) avocatCheckbox.addEventListener('change', toggleAvocatControls); toggleAvocatControls(); }catch(e){}
    // Theme handled by js/theme.js (shared module)
});

// expose globals used by HTML onclick attributes
window.add_fait = add_fait;
window.reset_faits = reset_faits;
window.med = med;
window.previewMed = previewMed;
window.copyPreview = copyPreview;
window.avocat = avocat;
window.appelDoj = appelDoj;
window.showPeineDetails = showPeineDetails;
window.updateDojButtonVisibility = updateDojButtonVisibility;
window.toggleAvocatControls = toggleAvocatControls;
